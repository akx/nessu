var N=Object.defineProperty;var k=(r,e,t)=>e in r?N(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var u=(r,e,t)=>(k(r,typeof e!="symbol"?e+"":e,t),t);import{R as a,u as E,e as T,d as O,a as F,n as I,b as W}from"./vendor.a871d0ee.js";const P=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function t(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerpolicy&&(o.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?o.credentials="include":n.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=t(n);fetch(n.href,o)}};P();let c,S=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});S.decode();let b=null;function x(){return(b===null||b.buffer!==c.memory.buffer)&&(b=new Uint8Array(c.memory.buffer)),b}function K(r,e){return S.decode(x().subarray(r,r+e))}let y=0;function v(r,e){const t=e(r.length*1);return x().set(r,t/1),y=r.length,t}let _=null;function C(){return(_===null||_.buffer!==c.memory.buffer)&&(_=new Float32Array(c.memory.buffer)),_}function q(r,e){const t=e(r.length*4);return C().set(r,t/4),y=r.length,t}const p=Object.freeze({Poweroff:0,0:"Poweroff",Reset:1,1:"Reset",Select:2,2:"Select",Start:3,3:"Start",Joypad1A:4,4:"Joypad1A",Joypad1B:5,5:"Joypad1B",Joypad1Up:6,6:"Joypad1Up",Joypad1Down:7,7:"Joypad1Down",Joypad1Left:8,8:"Joypad1Left",Joypad1Right:9,9:"Joypad1Right",Joypad2A:10,10:"Joypad2A",Joypad2B:11,11:"Joypad2B",Joypad2Up:12,12:"Joypad2Up",Joypad2Down:13,13:"Joypad2Down",Joypad2Left:14,14:"Joypad2Left",Joypad2Right:15,15:"Joypad2Right"});class g{static __wrap(e){const t=Object.create(g.prototype);return t.ptr=e,t}__destroy_into_raw(){const e=this.ptr;return this.ptr=0,e}free(){const e=this.__destroy_into_raw();c.__wbg_wasmnes_free(e)}static new(){var e=c.wasmnes_new();return g.__wrap(e)}set_rom(e){var t=v(e,c.__wbindgen_malloc),s=y;c.wasmnes_set_rom(this.ptr,t,s)}bootup(){c.wasmnes_bootup(this.ptr)}reset(){c.wasmnes_reset(this.ptr)}step(){c.wasmnes_step(this.ptr)}step_frame(){c.wasmnes_step_frame(this.ptr)}update_pixels(e){try{var t=v(e,c.__wbindgen_malloc),s=y;c.wasmnes_update_pixels(this.ptr,t,s)}finally{e.set(x().subarray(t/1,t/1+s)),c.__wbindgen_free(t,s*1)}}update_sample_buffer(e){try{var t=q(e,c.__wbindgen_malloc),s=y;c.wasmnes_update_sample_buffer(this.ptr,t,s)}finally{e.set(C().subarray(t/4,t/4+s)),c.__wbindgen_free(t,s*4)}}press_button(e){c.wasmnes_press_button(this.ptr,e)}release_button(e){c.wasmnes_release_button(this.ptr,e)}}async function j(r,e){if(typeof Response=="function"&&r instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(r,e)}catch(s){if(r.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",s);else throw s}const t=await r.arrayBuffer();return await WebAssembly.instantiate(t,e)}else{const t=await WebAssembly.instantiate(r,e);return t instanceof WebAssembly.Instance?{instance:t,module:r}:t}}async function D(r){typeof r=="undefined"&&(r=new URL("/nessu/assets/nes_rust_wasm_bg.1dce5c40.wasm",self.location));const e={};e.wbg={},e.wbg.__wbindgen_throw=function(n,o){throw new Error(K(n,o))},(typeof r=="string"||typeof Request=="function"&&r instanceof Request||typeof URL=="function"&&r instanceof URL)&&(r=fetch(r));const{instance:t,module:s}=await j(await r,e);return c=t.exports,D.__wbindgen_wasm_module=s,c}const z={Space:p.Start,ArrowLeft:p.Joypad1Left,ArrowRight:p.Joypad1Right,ArrowUp:p.Joypad1Up,ArrowDown:p.Joypad1Down,KeyA:p.Joypad1A,KeyB:p.Joypad1B,KeyS:p.Select};class V{constructor(e,t){u(this,"canvas");u(this,"nes");u(this,"ctx");u(this,"imageData");u(this,"pixels");u(this,"audioContext");u(this,"lastUpdateTime",0);u(this,"UPDATE_RATE",1e3/60);u(this,"crash",null);u(this,"handleKeyEvent",e=>{const t=z[e.code];return!t||this.crash?!1:(e.type==="keydown"?this.nes.press_button(t):this.nes.release_button(t),this.audioContext.resume(),!0)});u(this,"stepFrame",e=>{if(!(e-this.lastUpdateTime<this.UPDATE_RATE)){if(this.lastUpdateTime=e,this.crash)for(let t=0;t<256;t++){const s=Math.floor(Math.random()*(this.pixels.length-1)),n=this.pixels[s];this.pixels[s]=this.pixels[s]+1,this.pixels[s]=n+1}else try{this.nes.step_frame(),this.nes.update_pixels(this.pixels)}catch(t){this.crash={phase:"exec",error:t}}this.ctx.putImageData(this.imageData,0,0)}});this.canvas=e,this.audioContext=this.setupAudio(),this.nes=g.new();try{this.nes.set_rom(new Uint8Array(t))}catch(n){this.crash={phase:"load",error:n}}const s=e.getContext("2d");if(!s)throw new Error("oh no");this.ctx=s,this.imageData=s.createImageData(256,240),this.pixels=new Uint8Array(this.imageData.data.buffer)}setupAudio(){const e=new AudioContext({sampleRate:44100}),t=4096,s=e.createScriptProcessor(t,0,1);return s.onaudioprocess=n=>{if(this.crash)return;const o=n.outputBuffer.getChannelData(0);try{this.nes.update_sample_buffer(o)}catch(i){this.crash={phase:"audio",error:i}}for(let i=0;i<o.length;i++)o[i]*=.6},s.connect(e.destination),e}boot(){for(let e=0;e<this.pixels.length;e++)this.pixels[e]=e%4==3?255:e%256;this.ctx.putImageData(this.imageData,0,0);try{this.nes.bootup()}catch(e){this.crash={phase:"boot",error:e}}}stop(){if(this.audioContext.close(),!this.crash)try{this.nes.free()}catch(e){this.crash={phase:"stop",error:e}}}}function $(r){const e=a.useRef(null),t=a.useCallback(o=>{var i;((i=e.current)==null?void 0:i.handleKeyEvent(o))&&o.preventDefault()},[]);E("keydown",t,window),E("keyup",t,window);const s=a.useCallback(o=>{var i;e.current&&((i=e.current)==null||i.stepFrame(o),requestAnimationFrame(s))},[]);return{bootArrayBuffer:a.useCallback(o=>{var f;e.current&&((f=e.current)==null||f.stop(),e.current=null);const i=r.current;if(i){const d=new V(i,o);d.boot(),e.current=d,s(0)}},[])}}function G(r,e,t){const s=new F(e,I.xoshiro128ss),n={corruption:r,seed:e,xor:0,add:0},o=t.slice(0),i=new Uint8Array(o);for(let f=0;f<i.length;f++)s.next()<r&&(s.next()<.2?(i[f]^=s.next()*256,n.xor++):(i[f]++,n.add++));return[o,n]}function J(){return String(Math.floor(+new Date))}function H(){const r=a.useRef(null),e=a.useRef(null),[t,s]=a.useState(.1),n=Math.pow(t,3)*.1,[o,i]=a.useState({}),[f,d]=a.useState(J),{bootArrayBuffer:B}=$(r),R=a.useCallback((l,m)=>{const h=e.current;if(!h)return;const[w,M]=G(l,m,h);i(M),B(w)},[]),A=a.useCallback(()=>{R(n,f)},[n,f]),U=a.useCallback(()=>{const l=J();d(l),R(n,l)},[n]),L=a.useCallback(async l=>{var w;const m=(w=l.target.files)==null?void 0:w[0];if(!m)return;const h=await m.arrayBuffer();localStorage.setItem("nessu-last-rom",T(h)),e.current=h,A()},[]);return a.useEffect(()=>{const l=localStorage.getItem("nessu-last-rom");l&&(e.current=O(l),A())},[]),a.createElement("div",{className:"App"},a.createElement("div",{className:"controls"},a.createElement("div",null,"Select a NES ROM file:\xA0",a.createElement("input",{type:"file",onChange:L})),a.createElement("div",null,"Seed:",a.createElement("input",{type:"text",value:f,onChange:l=>d(l.target.value)})),a.createElement("div",null,"Corruption factor: ",(n*100).toPrecision(2),"%",a.createElement("input",{type:"range",min:0,max:1,step:.001,value:t,onChange:l=>s(l.target.valueAsNumber)})),a.createElement("div",{className:"buttons"},a.createElement("button",{onClick:U},"Reseed & restart"),a.createElement("button",{onClick:A},"Restart"))),a.createElement("div",{className:"corruption-info"},JSON.stringify(o,null,2)),a.createElement("div",{className:"display"},a.createElement("canvas",{ref:r,width:"256",height:"240",style:{width:"768px",imageRendering:"pixelated"}}),"Controls: arrows / A / B / space (start)"))}async function Q(){await D(),W.render(a.createElement(a.StrictMode,null,a.createElement(H,null)),document.getElementById("root"))}Q();
