const e={};import{R as t,u as a,b as s,a as n}from"./vendor.f2738210.js";let r,o=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});o.decode();let i=null;function l(){return null!==i&&i.buffer===r.memory.buffer||(i=new Uint8Array(r.memory.buffer)),i}let c=0;function u(e,t){const a=t(1*e.length);return l().set(e,a/1),c=e.length,a}let p=null;function h(){return null!==p&&p.buffer===r.memory.buffer||(p=new Float32Array(r.memory.buffer)),p}const d=Object.freeze({Poweroff:0,0:"Poweroff",Reset:1,1:"Reset",Select:2,2:"Select",Start:3,3:"Start",Joypad1A:4,4:"Joypad1A",Joypad1B:5,5:"Joypad1B",Joypad1Up:6,6:"Joypad1Up",Joypad1Down:7,7:"Joypad1Down",Joypad1Left:8,8:"Joypad1Left",Joypad1Right:9,9:"Joypad1Right",Joypad2A:10,10:"Joypad2A",Joypad2B:11,11:"Joypad2B",Joypad2Up:12,12:"Joypad2Up",Joypad2Down:13,13:"Joypad2Down",Joypad2Left:14,14:"Joypad2Left",Joypad2Right:15,15:"Joypad2Right"});class f{static __wrap(e){const t=Object.create(f.prototype);return t.ptr=e,t}__destroy_into_raw(){const e=this.ptr;return this.ptr=0,e}free(){const e=this.__destroy_into_raw();r.__wbg_wasmnes_free(e)}static new(){var e=r.wasmnes_new();return f.__wrap(e)}set_rom(e){var t=u(e,r.__wbindgen_malloc),a=c;r.wasmnes_set_rom(this.ptr,t,a)}bootup(){r.wasmnes_bootup(this.ptr)}reset(){r.wasmnes_reset(this.ptr)}step(){r.wasmnes_step(this.ptr)}step_frame(){r.wasmnes_step_frame(this.ptr)}update_pixels(e){try{var t=u(e,r.__wbindgen_malloc),a=c;r.wasmnes_update_pixels(this.ptr,t,a)}finally{e.set(l().subarray(t/1,t/1+a)),r.__wbindgen_free(t,1*a)}}update_sample_buffer(e){try{var t=function(e,t){const a=t(4*e.length);return h().set(e,a/4),c=e.length,a}(e,r.__wbindgen_malloc),a=c;r.wasmnes_update_sample_buffer(this.ptr,t,a)}finally{e.set(h().subarray(t/4,t/4+a)),r.__wbindgen_free(t,4*a)}}press_button(e){r.wasmnes_press_button(this.ptr,e)}release_button(e){r.wasmnes_release_button(this.ptr,e)}}async function m(t){void 0===t&&(t=new URL("nes_rust_wasm_bg.wasm",e.url));const a={wbg:{}};a.wbg.__wbindgen_throw=function(e,t){throw new Error((a=e,s=t,o.decode(l().subarray(a,a+s))));var a,s},("string"==typeof t||"function"==typeof Request&&t instanceof Request||"function"==typeof URL&&t instanceof URL)&&(t=fetch(t));const{instance:s,module:n}=await async function(e,t){if("function"==typeof Response&&e instanceof Response){if("function"==typeof WebAssembly.instantiateStreaming)try{return await WebAssembly.instantiateStreaming(e,t)}catch(a){if("application/wasm"==e.headers.get("Content-Type"))throw a;console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",a)}const s=await e.arrayBuffer();return await WebAssembly.instantiate(s,t)}{const a=await WebAssembly.instantiate(e,t);return a instanceof WebAssembly.Instance?{instance:a,module:e}:a}}(await t,a);return r=s.exports,m.__wbindgen_wasm_module=n,r}const y={Space:d.Start,ArrowLeft:d.Joypad1Left,ArrowRight:d.Joypad1Right,ArrowUp:d.Joypad1Up,ArrowDown:d.Joypad1Down,KeyA:d.Joypad1A,KeyB:d.Joypad1B,KeyS:d.Select};class w{constructor(e,t){this.lastUpdateTime=0,this.UPDATE_RATE=1e3/60,this.crash=null,this.handleKeyEvent=e=>{const t=y[e.code];return!(!t||this.crash)&&("keydown"===e.type?this.nes.press_button(t):this.nes.release_button(t),this.audioContext.resume(),!0)},this.stepFrame=e=>{if(!(e-this.lastUpdateTime<this.UPDATE_RATE)){if(this.lastUpdateTime=e,this.crash)for(let e=0;e<256;e++){const e=Math.floor(Math.random()*(this.pixels.length-1)),t=this.pixels[e];this.pixels[e]=this.pixels[e]+1,this.pixels[e]=t+1}else try{this.nes.step_frame(),this.nes.update_pixels(this.pixels)}catch(t){this.crash={phase:"exec",error:t}}this.ctx.putImageData(this.imageData,0,0)}},this.canvas=e,this.audioContext=this.setupAudio(),this.nes=f.new();try{this.nes.set_rom(new Uint8Array(t))}catch(s){this.crash={phase:"load",error:s}}const a=e.getContext("2d");if(!a)throw new Error("oh no");this.ctx=a,this.imageData=a.createImageData(256,240),this.pixels=new Uint8Array(this.imageData.data.buffer)}setupAudio(){const e=new AudioContext({sampleRate:44100}),t=e.createScriptProcessor(4096,0,1);return t.onaudioprocess=e=>{if(this.crash)return;const t=e.outputBuffer.getChannelData(0);try{this.nes.update_sample_buffer(t)}catch(a){this.crash={phase:"audio",error:a}}for(let s=0;s<t.length;s++)t[s]*=.6},t.connect(e.destination),e}boot(){for(let t=0;t<this.pixels.length;t++)this.pixels[t]=t%4==3?255:t%256;this.ctx.putImageData(this.imageData,0,0);try{this.nes.bootup()}catch(e){this.crash={phase:"boot",error:e}}}stop(){if(this.audioContext.close(),!this.crash)try{this.nes.free()}catch(e){this.crash={phase:"stop",error:e}}}}function _(){const e=t.useRef(null),n=t.useRef(null),[r,o]=t.useState(5e-4),[i,l]=t.useState({}),{bootArrayBuffer:c}=function(e){const s=t.useRef(null),n=t.useCallback((e=>{var t;(null==(t=s.current)?void 0:t.handleKeyEvent(e))&&e.preventDefault()}),[]);a("keydown",n,window),a("keyup",n,window);const r=t.useCallback((e=>{var t;s.current&&(null==(t=s.current)||t.stepFrame(e),requestAnimationFrame(r))}),[]);return{bootArrayBuffer:t.useCallback((t=>{var a;s.current&&(null==(a=s.current)||a.stop(),s.current=null);const n=e.current;if(n){const e=new w(n,t);e.boot(),s.current=e,r(0)}}),[])}}(e),u=t.useCallback((e=>{const t={corruption:r,xor:0,add:0},a=e.slice(0),s=new Uint8Array(a);for(let n=0;n<s.length;n++)Math.random()<r&&(Math.random()<.2?(s[n]^=256*Math.random(),t.xor++):(s[n]++,t.add++));return[a,t]}),[r]),p=t.useCallback((()=>{const e=n.current;if(!e)return;const[t,a]=u(e);l(a),c(t)}),[u]),h=t.useCallback((async e=>{var t;const a=null==(t=e.target.files)?void 0:t[0];if(!a)return;const r=await a.arrayBuffer();localStorage.setItem("nessu-last-rom",s.encode(r)),n.current=r,p()}),[]);return t.useEffect((()=>{const e=localStorage.getItem("nessu-last-rom");e&&(n.current=s.decode(e),p())}),[]),t.createElement("div",{className:"App"},t.createElement("div",{className:"controls"},t.createElement("div",null,"Select a NES ROM file:Â ",t.createElement("input",{type:"file",onChange:h})),t.createElement("div",null,"Corruption factor:",t.createElement("input",{type:"range",min:0,max:.1,step:1e-6,value:r,onChange:e=>o(e.target.valueAsNumber)}),(100*r).toPrecision(2),"%"),t.createElement("div",null,JSON.stringify(i)),t.createElement("button",{onClick:p},"Restart")),t.createElement("div",{className:"display"},t.createElement("canvas",{ref:e,width:"256",height:"240",style:{width:"768px",imageRendering:"pixelated"}}),"Controls: arrows / A / B / space (start)"))}!async function(){await m(),n.render(t.createElement(t.StrictMode,null,t.createElement(_,null)),document.getElementById("root"))}();
